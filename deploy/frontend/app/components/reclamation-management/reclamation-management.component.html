<div class="container my-4">
  <div class="card">
    <div class="card-header bg-primary text-white">
      <h3 class="mb-0">إدارة الشكايات - البحث</h3>
    </div>
    <div class="card-body">
      <form [formGroup]="searchForm" (ngSubmit)="searchReclamationsPage()">
        <!-- Groupe 1 : المعلومات الشخصية -->
        <div class="search-group mb-3" style="border: 2px solid #007bff; padding: 10px; border-radius: 5px;">
          <h5 class="mb-3">المعلومات الشخصية</h5>
          <div class="row mt-2">
            <div class="col-md-4">
              <label>المعرف</label>
              <input type="text" formControlName="identifiant" class="form-control" />
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-md-4">
              <label>الاسم الكامل</label>
              <input type="text" formControlName="nomComplet" class="form-control" />
            </div>
            <div class="col-md-4">
              <label>الهاتف</label>
              <input type="text" formControlName="telephone" class="form-control" placeholder="" />
            </div>
          </div>
        </div>

        <!-- Groupe 2 : تفاصيل الشكاية -->
        <div class="search-group mb-3" style="border: 2px solid #28a745; padding: 10px; border-radius: 5px;">
          <h5 class="mb-3">تفاصيل الشكاية</h5>
          <div class="row">
            <div class="col-md-6">
              <label>تاريخ الإيداع (من)</label>
              <input type="date" formControlName="dateDepotStart" class="form-control" />
            </div>
            <div class="col-md-6">
              <label>تاريخ الإيداع (إلى)</label>
              <input type="date" formControlName="dateDepotEnd" class="form-control" />
            </div>
          </div>
          <div class="row">
            <div class="col-md-4">
              <label>رقم التسجيل</label>
              <input type="text" formControlName="numInscription" class="form-control" />
            </div>
            <div class="col-md-4">
              <label>المرجع BO</label>
              <input type="text" formControlName="referenceBo" class="form-control" />
            </div>
            <div class="col-md-4">
              <label>السنة</label>
              <input type="number" formControlName="annee" class="form-control" />
            </div>
            <div class="col-md-4">
              <label>نوع الشكاية</label>
              <select formControlName="typeReclamation" class="form-select">
                <option value="">-- اختر --</option>
                <option *ngFor="let type of typeReclamations" [value]="type.id">{{ type.nomLangue2 }}</option>
              </select>
            </div>
            <div class="col-md-4">
              <label>النفوذ الترابي</label>
              <select formControlName="commune" class="form-select">
                <option value="">-- اختر --</option>
                <option *ngFor="let com of communes" [value]="com">{{ com }}</option>
              </select>
            </div>
            <div class="col-md-4">
              <label>مصدر الشكاية</label>
              <select formControlName="sourceReclamation" class="form-select">
                <option value="">-- اختر --</option>
                <option *ngFor="let src of sourceReclamations" [value]="src.id">{{ src.nomLangue2 }}</option>
              </select>
            </div>
            <div class="col-md-4">
              <label>نوع الطلب</label>
              <select formControlName="typeRequete" class="form-select">
                <option value="">-- اختر --</option>
                <option *ngFor="let req of typeRequetes" [value]="req.id">{{ req.nomLangue2 }}</option>
              </select>
            </div>
            <div class="col-md-4">
              <label>موضوع الشكاية</label>
              <input type="text" formControlName="objetReclamation" class="form-control" />
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-md-4">
              <label>تعليمات المحافظ</label>
              <input type="text" formControlName="instructionsGouverneur" class="form-control" />
            </div>
            <div class="col-md-4">
              <label>الملاحظة 1</label>
              <input type="text" formControlName="observation1" class="form-control" />
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-md-4">
              <label>الملاحظة 2</label>
              <input type="text" formControlName="observation2" class="form-control" />
            </div>
            <div class="col-md-4">
              <label>المستخدم (الإدخال)</label>
              <select formControlName="userSaisie" class="form-select">
                <option value="">-- اختر --</option>
                <option *ngFor="let user of userLogins" [value]="user.id">{{ user.login }}</option>
              </select>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-md-4">
              <label>حالة الإغلاق</label>
              <div class="form-check">
                <input type="checkbox" formControlName="flagCloture" class="form-check-input" id="flagCloture">
                <label class="form-check-label" for="flagCloture">مغلقة</label>
              </div>
            </div>
          </div>
        </div>

        <!-- Groupe 3 : تفاصيل المراسلات -->
        <div class="search-group mb-3" style="border: 2px solid #ffc107; padding: 10px; border-radius: 5px;">
          <h5 class="mb-3">تفاصيل المراسلات</h5>
          <!-- (critères concernant reclamations_detail) -->
          <div class="row">
            <div class="col-md-4">
              <div class="form-check">
                <input type="checkbox" formControlName="flagEnvoiAutorite" class="form-check-input" id="flagEnvoiAutoriteDetail">
                <label class="form-check-label" for="flagEnvoiAutoriteDetail">تم إرسال السلطة</label>
              </div>
            </div>
            <div class="col-md-4">
              <label>تاريخ إرسال السلطة (من)</label>
              <input type="date" formControlName="dateEnvoiAutoriteStart" class="form-control">
            </div>
            <div class="col-md-4">
              <label>تاريخ إرسال السلطة (إلى)</label>
              <input type="date" formControlName="dateEnvoiAutoriteEnd" class="form-control">
            </div>
            <div class="col-md-4">
              <label>مرجع إرسال السلطة</label>
              <input type="text" formControlName="referenceEnvoiAutorite" class="form-control" />
            </div>            
          </div>
          <div class="row mt-2">

            <div class="col-md-4">
              <div class="form-check">
                <input type="checkbox" formControlName="flagRetourAutorite" class="form-check-input" id="flagRetourAutoriteDetail">
                <label class="form-check-label" for="flagRetourAutoriteDetail">تم رد السلطة</label>
              </div>
            </div>
            <div class="col-md-4">
              <label>تاريخ رد السلطة (من)</label>
              <input type="date" formControlName="dateRetourAutoriteStart" class="form-control">
            </div>
            <div class="col-md-4">
              <label>تاريخ رد السلطة (إلى)</label>
              <input type="date" formControlName="dateRetourAutoriteEnd" class="form-control">
            </div>  
            <div class="col-md-4">
              <label>مرجع رد السلطة</label>
              <input type="text" formControlName="referenceRetourAutorite" class="form-control" />
            </div>                      
          </div>
          <div class="row mt-2">


          </div>
          <div class="row mt-2">
            <div class="col-md-4">
              <div class="form-check">
                <input type="checkbox" formControlName="flagEnvoiReclamant" class="form-check-input" id="flagEnvoiReclamantDetail">
                <label class="form-check-label" for="flagEnvoiReclamantDetail">تم إرسال الرد</label>
              </div>
            </div>
            <div class="col-md-4">
              <label>تاريخ إرسال الرد (من)</label>
              <input type="date" formControlName="dateEnvoiReclamantStart" class="form-control">
            </div>
            <div class="col-md-4">
              <label>تاريخ إرسال الرد (إلى)</label>
              <input type="date" formControlName="dateEnvoiReclamantEnd" class="form-control">
            </div>
            <div class="col-md-4">
              <label>القناة</label>
              <select formControlName="voieEnvoiReclamant" class="form-select">
                <option value="">-- اختر --</option>
                <option *ngFor="let voie of voieReponses" [value]="voie.id">{{ voie.nomLangue2 }}</option>
              </select>
            </div>
            <div class="col-md-4">
              <label>مرجع إرسال الرد</label>
              <input type="text" formControlName="referenceEnvoiReclamant" class="form-control">
            </div>
          </div>
          <div class="row mt-2">

            <div class="col-md-4">
              <label>المستخدم (إرسال السلطة)</label>
              <select formControlName="userEnvoiAutorite" class="form-select">
                <option value="">-- اختر --</option>
                <option *ngFor="let user of userLogins" [value]="user.id">{{ user.login }}</option>
              </select>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-md-4">
              <label>المستخدم (رد السلطة)</label>
              <select formControlName="userRetourAutorite" class="form-select">
                <option value="">-- اختر --</option>
                <option *ngFor="let user of userLogins" [value]="user.id">{{ user.login }}</option>
              </select>
            </div>
            <div class="col-md-4">
              <label>المستخدم (إرسال الرد)</label>
              <select formControlName="userEnvoiReclamant" class="form-select">
                <option value="">-- اختر --</option>
                <option *ngFor="let user of userLogins" [value]="user.id">{{ user.login }}</option>
              </select>
            </div>
          </div>
        </div> <!-- Fin groupe détails Mirsaslat -->
        <div class="row mt-3">
          <div class="col-md-12 text-end">
            <button type="submit" class="btn btn-success">بحث</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Tableau des résultats -->
  <div class="card mt-4">
    <div class="card-header bg-secondary text-white">
      <h4 class="mb-0">قائمة الشكايات</h4>
    </div>
    <div class="card-body table-responsive">
      <table class="table table-bordered table-striped">
        <thead class="table-dark">
          <tr>
            <th>تاريخ الإيداع</th>
            <th>رقم التسجيل</th>
            <th>المعرف</th>
            <th>الاسم الكامل</th>
            <th>مصدر الشكاية</th>
            <th>نوع الشكاية</th>
            <th>موضوع الشكاية</th>
            <th>نوع الطلب</th>
            <th>الإرسال إلى السلطة</th>
            <th>الرد من الهيئة</th>
            <th>إرسال إلى صاحب الشكاية</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let rec of reclamations">
            <td>{{ rec.dateDepot | date:'dd/MM/yyyy' }}</td>
            <td>{{ formatNumInscription(rec.numInscription) }}</td>
            <td>{{ rec.identifiant }}</td>
            <td>{{ rec.nomComplet }}</td>
            <td>{{ rec.sourceReclamation?.nomLangue2 }}</td>
            <td>{{ rec.typeReclamation?.nomLangue2 }}</td>
            <td>{{ rec.objetReclamation }}</td>
            <td>{{ rec.typeRequete?.nomLangue2 }}</td>
            <td>{{ rec.flagEnvoiAutorite == 1 ? 'نعم' : 'لا' }}</td>
            <td>{{ rec.flagRetourAutorite == 1 ? 'نعم' : 'لا' }}</td>
            <td>{{ rec.flagEnvoiReclamant == 1 ? 'نعم' : 'لا' }}</td>
            <td>
              <button class="btn btn-info btn-sm" (click)="consultReclamation(rec)">عرض</button>
              <button class="btn btn-warning btn-sm" (click)="editReclamation(rec)">تعديل</button>
              <button class="btn btn-danger btn-sm" (click)="deleteReclamation(rec.id)">حذف</button>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="d-flex justify-content-between align-items-center mt-3">
        <div>
          <label for="pageSize">عدد العناصر لكل صفحة:</label>
          <select id="pageSize" [(ngModel)]="pageSize" (change)="onPageSizeChange()">
            <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
          </select>
        </div>
        <div>
          <button class="btn btn-primary" (click)="previousPage()" [disabled]="currentPage === 0">سابق</button>
          <span>Page {{ currentPage + 1 }} sur {{ totalPages }}</span>
          <button class="btn btn-primary" (click)="nextPage()" [disabled]="currentPage >= totalPages - 1">التالي</button>
        </div>
        <div>
          <button class="btn btn-success" (click)="exportExcel()">تصدير إلى إكسل</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de consultation / édition -->
<div class="modal fade show" tabindex="-1" style="display: block;" *ngIf="selectedReclamation" dir="rtl">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">{{ isConsultation ? 'عرض الشكاية' : 'تعديل الشكاية' }}</h5>
        <button type="button" class="btn-close" (click)="closeModal()"></button>
      </div>
      <div class="modal-body">
        <form *ngIf="selectedReclamation">
          <!-- Bloc regroupant les champs principaux -->
          <div class="search-group mb-3" style="border: 2px solid #007bff; padding: 10px; border-radius: 5px;">
		  
          <div class="search-group mb-3" style="border: 2px solid #007bff; padding: 10px; border-radius: 5px;">
            <h5 class="mb-3">المعلومات الشخصية</h5>
            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label">نوع المعرف</label>
                <input type="text" class="form-control" [(ngModel)]="selectedReclamation.typeIdentifiant" name="typeIdentifiant" [disabled]="isConsultation" />
              </div>
              <div class="col-md-4">
                <label class="form-label">المعرف</label>
                <input type="text" class="form-control" [(ngModel)]="selectedReclamation.identifiant" name="identifiant" (blur)="formatIdentifiant()" [disabled]="isConsultation" />
              </div>	
              <div class="col-md-4">
                <label class="form-label">الاسم الكامل</label>
                <input type="text" class="form-control" [(ngModel)]="selectedReclamation.nomComplet" name="nomComplet" [disabled]="isConsultation" />
              </div>	
              <div class="col-md-4">
                <label class="form-label">العنوان</label>
                <input type="text" class="form-control" [(ngModel)]="selectedReclamation.adresse" name="adresse" [disabled]="isConsultation" />
              </div>	
				<div class="col-md-4">
				  <label class="form-label">الهاتف</label>
				  <input type="tel" class="form-control"
						 [(ngModel)]="selectedReclamation.telephone"
						 name="telephone"
						 [disabled]="isConsultation" />
				</div>







			  

            </div>
          </div>
          <!-- Groupe supplémentaire : تفاصيل الشكاية (champs existants) -->
          <div class="search-group mb-3" style="border: 2px solid #28a745; padding: 10px; border-radius: 5px;">
            <h5 class="mb-3">تفاصيل الشكاية</h5>
            <div class="row mb-3">
						              <div class="col-md-4">
                            <label class="form-label">تاريخ الإيداع</label>
                            <input type="date" class="form-control" [(ngModel)]="selectedReclamation.dateDepot" name="dateDepot" [disabled]="isConsultation" />
                          </div>

			              <div class="col-md-4">
                <label class="form-label">السنة</label>
                <input type="number" class="form-control" [(ngModel)]="selectedReclamation.annee" name="annee" [disabled]="isConsultation" />
              </div>
						                <div class="col-md-4">
                <label class="form-label">رقم التسجيل</label>
                <input type="text" class="form-control" [(ngModel)]="selectedReclamation.numInscription" name="numInscription" disabled />
              </div>
              <div class="col-md-4">
                <label class="form-label">نوع الطلب</label>
                <select class="form-select" [(ngModel)]="selectedReclamation.typeRequete" name="typeRequete" [disabled]="isConsultation" [compareWith]="compareById">
                  <option [ngValue]="null">-- اختر --</option>
                  <option *ngFor="let req of typeRequetes" [ngValue]="req">{{ req.nomLangue2 }}</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">نوع الشكاية</label>
                <select class="form-select" [(ngModel)]="selectedReclamation.typeReclamation" name="typeReclamation" [disabled]="isConsultation" [compareWith]="compareById">
                  <option [ngValue]="">-- اختر --</option>
                  <option *ngFor="let type of typeReclamations" [ngValue]="type">{{ type.nomLangue2 }}</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">موضوع الشكاية</label>
                <input type="text" class="form-control" [(ngModel)]="selectedReclamation.objetReclamation" name="objetReclamation" [disabled]="isConsultation" />
              </div>			  
              <div class="col-md-4">
                <label class="form-label">مصدر الشكاية</label>
                <select class="form-select" [(ngModel)]="selectedReclamation.sourceReclamation" name="sourceReclamation" [disabled]="isConsultation" [compareWith]="compareById">
                  <option [ngValue]="null">-- اختر --</option>
                  <option *ngFor="let src of sourceReclamations" [ngValue]="src">{{ src.nomLangue2 }}</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">ملاحظة</label>
                <input type="text" class="form-control" [(ngModel)]="selectedReclamation.observation1" name="observation1" [disabled]="isConsultation" />
              </div>			
              <div class="col-md-4">
                <label class="form-label">تعليمات سيد العامل</label>
                <input type="text" class="form-control" [(ngModel)]="selectedReclamation.instructionsGouverneur" name="instructionsGouverneur" [disabled]="isConsultation" />
              </div>
			  
            </div>
			
			
          </div>		  
		  
		  
		 

          </div>
          <!-- Bloc des détails (affichage en lecture seule ou modification/suppression) -->
          <div class="card mt-3">
            <div class="card-header bg-secondary text-white">
              <h5 class="mb-0">تفاصيل المراسلات</h5>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
              <table class="table table-bordered table-striped">
                <thead>
                  <tr>
                    <th>إرسال السلطة</th>
                    <th>تاريخ إرسال السلطة</th>
                    <th>نوع المستلم</th>
                    <th>مرجع إرسال السلطة</th>
                    <th>رد السلطة</th>
                    <th>تاريخ رد السلطة</th>
                    <th>طريقة رد السلطة</th>
                    <th>مرجع رد السلطة</th>
                    <th>إرسال الرد</th>
                    <th>تاريخ إرسال الرد</th>
                    <th>طريقة إرسال الرد</th>
                    <th>مرجع إرسال الرد</th>
                    <th *ngIf="!isConsultation">إجراءات</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let detail of selectedReclamation.details">
                    <td>{{ detail.flagEnvoiAutorite == 1 ? 'نعم' : 'لا' }}</td>
                    <td>{{ detail.dateEnvoiAutorite ? (detail.dateEnvoiAutorite | date:'dd/MM/yyyy') : '' }}</td>
                    <td>{{ detail.typeDestinataire?.nomLangue2 }}</td>
                    <td>{{ detail.referenceEnvoiAutorite }}</td>
                    <td>{{ detail.flagRetourAutorite == 1 ? 'نعم' : 'لا' }}</td>
                    <td>{{ detail.dateRetourAutorite ? (detail.dateRetourAutorite | date:'dd/MM/yyyy') : '' }}</td>
                    <td>{{ detail.voieRetourAutorote }}</td>
                    <td>{{ detail.referenceRetourAutorote }}</td>
                    <td>{{ detail.flagEnvoiReclamant == 1 ? 'نعم' : 'لا' }}</td>
                    <td>{{ detail.dateEnvoiReclamant ? (detail.dateEnvoiReclamant | date:'dd/MM/yyyy') : '' }}</td>
                    <td>{{ detail.voieEnvoiReclamant }}</td>
                    <td>{{ detail.referenceEnvoiReclamant }}</td>
                    <td *ngIf="!isConsultation">
                      <button type="button" class="btn btn-danger btn-sm" (click)="removeDetail(detail)">حذف</button>
                    </td>
                  </tr>
                  <tr *ngIf="!selectedReclamation.details || selectedReclamation.details.length === 0">
                    <td colspan="13" class="text-center">لا توجد تفاصيل</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <!-- Groupe supplémentaire : المعلومات الشخصية (champs existants) -->

          <!-- Bouton d'enregistrement (affiché uniquement en mode modification) -->
          <div class="mt-3 text-end" *ngIf="!isConsultation">
            <button type="button" class="btn btn-success" (click)="saveReclamation()">حفظ التغييرات</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
